<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ニコリタウン 接続診断</title>
<style>
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:#0b1220; color:#e2e8f0; margin:0; padding:24px}
  .card{background:#111827; border:1px solid #334155; border-radius:12px; padding:16px; max-width:720px}
  input,button{font:inherit; padding:8px 10px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e2e8f0}
  button{background:linear-gradient(180deg,#22d3ee,#06b6d4); border:0; color:#06202a; font-weight:700; cursor:pointer}
  code{background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #334155}
  .log{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b1220; border:1px solid #334155; border-radius:10px; padding:10px; height:200px; overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <h2>接続診断（Realtime Database）</h2>
    <p>同じルームに入れない時の原因切り分け用。2つのタブで同じルームIDを入力して「入室」を押してください。</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
      <label>ルームID: <input id="room" placeholder="room-test" value="room-test"></label>
      <label>名前: <input id="name" placeholder="namae" value="diag"></label>
      <button id="join">入室</button>
      <button id="leave">退室</button>
    </div>
    <p>自分のID: <code id="myid">-</code>　|　接続: <code id="status">未接続</code></p>
    <p>プレイヤー一覧:</p>
    <div id="list" class="log"></div>
    <p>ログ:</p>
    <div id="log" class="log"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, push, set, remove, onChildAdded, onChildRemoved, onDisconnect } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCy3P-HQhfd8-zpPUJ5YANxwRMuTCjFFAQ",
  authDomain: "nikori-town.firebaseapp.com",
  databaseURL: "https://nikori-town-default-rtdb.firebaseio.com",
  projectId: "nikori-town",
  storageBucket: "nikori-town.firebasestorage.app",
  messagingSenderId: "836836010871",
  appId: "1:836836010871:web:74ae40cb16ee6d50368f72",
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $ = s => document.querySelector(s);
const log = (m)=>{ const el=$("#log"); el.textContent += m + "\n"; el.scrollTop = el.scrollHeight; };
const renderList = (players)=>{ $("#list").textContent = Object.entries(players).map(([k,v])=>`${k}: ${v?.name||'?'}`).join("\n"); };

let roomId = null, myRef = null, playersRef = null;
let players = {};

$("#join").onclick = async () => {
  roomId = ($("#room").value || "room-test").trim().toLowerCase();
  const name = ($("#name").value || "diag").slice(0,16);
  playersRef = ref(db, `rooms/${roomId}/players`);
  myRef = push(playersRef);
  await set(myRef, { name, ts: Date.now() });
  onDisconnect(myRef).remove();
  $("#myid").textContent = myRef.key;
  $("#status").textContent = "入室中";

  onChildAdded(playersRef, snap => { players[snap.key]=snap.val(); renderList(players); });
  onChildRemoved(playersRef, snap => { delete players[snap.key]; renderList(players); });

  log(`入室: rooms/${roomId}/players/${myRef.key}`);
};

$("#leave").onclick = async () => {
  if (myRef){ await remove(myRef); $("#status").textContent = "退室"; log("退室"); }
};
</script>
</body>
</html>
