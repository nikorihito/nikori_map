<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>„Éã„Ç≥„É™„Çø„Ç¶„É≥ - „É´„Éº„É†ÔºàÂΩì„Åü„ÇäÂà§ÂÆö + Ê∑ª‰ªò„Éó„É¨„Éì„É•„Éº‰øÆÊ≠£Ôºâ</title>
<style>
  :root{--bg:#0b1220;--panel2:#101826;--border:#334155;--text:#e2e8f0;--muted:#9aa6b2;--a1:#22d3ee;--a2:#06b6d4;--chip:#0f172a;--yellow:#fde68a33;--yellowBorder:#facc15;--mention:#22d3ee}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;overflow:hidden;touch-action:none}
  #game{display:block;width:100vw;height:100vh;image-rendering:pixelated}

  /* HUD */
  .hud{position:fixed;left:8px;top:8px;display:flex;gap:8px;align-items:center;z-index:20}
  .hud .info{background:var(--panel2);border:1px solid var(--border);padding:6px 10px;border-radius:10px}
  .hud button{font:inherit;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,var(--a1),var(--a2));color:#06202a;font-weight:700;cursor:pointer}

  /* Chat */
  #chatView{position:fixed;right:8px;top:8px;z-index:20;width:min(36vw,520px);max-height:55vh;overflow:auto;background:rgba(16,24,38,.85);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:12px;padding:8px}
  #chatView .item{padding:6px 8px;border-radius:8px;margin:6px 0;position:relative}
  #chatView .me{background:rgba(34,211,238,.12)}
  #chatView .replyTo{display:block;font-size:.85rem;color:var(--muted);background:rgba(148,163,184,.12);padding:4px 6px;border-left:3px solid #64748b;border-radius:6px;margin-bottom:4px;cursor:pointer}
  .replyToMe{background:var(--yellow); border:1px solid var(--yellowBorder)}
  .mentionSelf{color:var(--mention);font-weight:700}
  .meta{color:var(--muted);font-size:.8rem;margin-top:2px}
  .file{display:flex;align-items:flex-start;gap:8px;padding:6px;border:1px solid var(--border);border-radius:8px;background:#0b1220;margin-top:4px}
  .file img{max-width:220px;max-height:160px;display:block;border-radius:6px}
  .file audio,.file video{max-width:280px}

  /* Composer */
  #composer{position:fixed;left:50%;bottom:8px;transform:translateX(-50%);display:flex;gap:6px;z-index:20;background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:6px}
  #composer input{font:inherit;width:min(60vw,720px);padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0b1220;color:#e2e8f0}
  #composer button{font:inherit;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,var(--a1),var(--a2));color:#06202a;font-weight:700;cursor:pointer}
  #attachBtn{background:transparent;border:1px dashed var(--border);color:#e2e8f0}
  #fileChip{position:fixed;left:50%;bottom:56px;transform:translateX(-50%);z-index:21;display:none;gap:8px;align-items:center;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:10px}
  #fileChip .x{cursor:pointer;opacity:.85}

  /* Ctx menu */
  #ctxMenu{position:fixed;z-index:50;display:none;background:#101826;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  #ctxMenu button{display:block;width:200px;text-align:left;padding:10px 12px;background:transparent;border:0;color:#e2e8f0;cursor:pointer}
  #ctxMenu button:hover{background:#1b2540}

  /* Reaction FAB & palette */
  #reactFab{position:fixed;right:16px;bottom:96px;z-index:24;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-size:22px;border:1px solid var(--border);background:linear-gradient(180deg,var(--a1),var(--a2));color:#06202a;box-shadow:0 8px 22px rgba(0,0,0,.35)}
  #reactMenu{position:fixed;right:16px;bottom:160px;z-index:25;display:none;background:#101826;border:1px solid var(--border);border-radius:12px;padding:6px}
  #reactMenu button{font-size:22px;line-height:1.2;padding:6px 8px;background:transparent;border:0;cursor:pointer}

  /* Bubbles */
  .bubble{position:absolute;transform:translate(-50%,-100%);background:#101826;border:1px solid var(--border);border-radius:12px;padding:6px 10px;font-size:20px}

  /* Attach modal */
  #attachModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:40}
  #attachPanel{width:min(90vw,560px);background:#101826;border:1px solid var(--border);border-radius:12px;padding:16px}
  .drop{border:2px dashed #64748b;border-radius:12px;padding:28px;text-align:center;color:#cbd5e1;background:rgba(15,23,42,.6)}
  .drop.drag{background:rgba(34,211,238,.12);border-color:#22d3ee}
</style>
</head>
<body>
  <canvas id="game"></canvas>

  <div class="hud">
    <button id="leave" title="ÈÄÄÂÆ§">ÈÄÄÂÆ§</button>
    <div class="info">„É´„Éº„É†: <span id="roomId">-</span>Ôºè Ëá™ÂàÜ: <span id="who">-</span>Ôºè ‰∫∫Êï∞: <span id="count">0</span></div>
  </div>

  <div id="chatView"></div>
  <div id="composer">
    <button id="attachBtn" title="„Éï„Ç°„Ç§„É´Ê∑ª‰ªò">üìÅ</button>
    <input id="text" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏‚Ä¶ (@Ëá™ÂàÜ„ÅØÊ∞¥Ëâ≤ / Ëøî‰ø°„ÅØÂè≥„ÇØ„É™„ÉÉ„ÇØ)" maxlength="2000" />
    <button id="send">ÈÄÅ‰ø°</button>
    <input id="filePick" type="file" style="display:none" />
  </div>
  <div id="fileChip"><span id="fileName"></span> <span class="x" id="fileClear">‚úï</span></div>

  <div id="ctxMenu">
    <button id="ctxReply">Ëøî‰ø°</button>
    <button id="ctxReactOpen">„É™„Ç¢„ÇØ„Ç∑„Éß„É≥</button>
    <button id="editMsg">Á∑®ÈõÜ</button>
    <button id="delMsg">ÂâäÈô§</button>
  </div>

  <!-- Ê∑ª‰ªò„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
  <div id="attachModal">
    <div id="attachPanel">
      <h3 style="margin:0 0 8px">„Éï„Ç°„Ç§„É´„ÇíÊ∑ª‰ªò</h3>
      <div id="drop" class="drop">
        „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó<br/>
        <small>„Åæ„Åü„ÅØ</small>
        <button id="pickFromPc" style="margin-top:8px">„Éë„ÇΩ„Ç≥„É≥„Åã„Çâ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
      </div>
      <div style="margin-top:10px;text-align:right"><button id="attachClose" class="ghost">Èñâ„Åò„Çã</button></div>
    </div>
  </div>

  <button id="reactFab" title="„É™„Ç¢„ÇØ„Ç∑„Éß„É≥">üòä</button>
  <div id="reactMenu"></div>

<script type="module">
/* ===== Params ===== */
const SCALE=1.4, SPEED_PPS=320, RADIUS=10, PLAYER_INTERP=12, CAM_INTERP=10, SYNC_MS=50, MAX_MSG=120, FRAME_MIN=1000/50;
const EMOJIS=['üëç','‚ù§Ô∏è','üòÇ','üéâ','üòÆ','üôè','üî•','üò¢'];

/* ===== Firebase ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
import { getDatabase, ref, onDisconnect, set, update, remove, onValue, push, limitToLast, query, onChildAdded, onChildChanged, onChildRemoved } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';
import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

const firebaseConfig={apiKey:'AIzaSyCy3P-HQhfd8-zpPUJ5YANxwRMuTCjFFAQ',authDomain:'nikori-town.firebaseapp.com',databaseURL:'https://nikori-town-default-rtdb.firebaseio.com',projectId:'nikori-town',storageBucket:'nikori-town.appspot.com',messagingSenderId:'836836010871',appId:'1:836836010871:web:74ae40cb16ee6d50368f72'};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getDatabase(app); const storage=getStorage(app);

// === quick diagnostics ===
warn('dbURL: '+ (app?.options?.databaseURL || '(none)'));
onValue(ref(db, '.info/connected'), s => { warn('connected: '+s.val()); });
(async function quickDiag(){
  try{
    await ensureAnonAuth(auth);
    const pingRef = ref(db, `rooms/_diag/ping_${Date.now()}`);
    await set(pingRef, {ts: Date.now()});
    warn('diag: write OK');
  }catch(e){
    warn('diag: write ERROR '+((e&&e.code)||'')+' '+((e&&e.message)||e));
  }
})();

/* ===== URL ===== */
const u=new URL(location.href); const ROOM=(u.searchParams.get('room')||'room-001').toLowerCase(); const NAME=u.searchParams.get('name')||'guest';
roomId.textContent=ROOM; who.textContent=NAME;

/* ===== Assets ===== */
function loadImage(src, {fallbackSize=[2048,2048], label='asset'}={}){return new Promise((res)=>{const i=new Image(); i.onload=()=>res(i); i.onerror=()=>{console.error('Image load failed:', src); warn(`ÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó: ${src}`); try{const c=document.createElement('canvas'); c.width=fallbackSize[0]; c.height=fallbackSize[1]; const g=c.getContext('2d'); g.fillStyle='#0f172a'; g.fillRect(0,0,c.width,c.height); g.fillStyle='#334155'; g.fillText(label,10,20); const img=new Image(); img.onload=()=>res(img); img.src=c.toDataURL();}catch{const img=new Image(); img.src='data:image/gif;base64,R0lGODlhAQABAAAAACw='; img.onload=()=>res(img);} }; i.src=src;});}
function warn(msg){ let box=document.getElementById('warnBox'); if(!box){ box=document.createElement('div'); box.id='warnBox'; Object.assign(box.style,{position:'fixed',left:'8px',bottom:'8px',zIndex:9999,background:'#101826',color:'#facc15',border:'1px solid #334155',padding:'6px 10px',borderRadius:'8px',maxWidth:'60vw',fontSize:'12px'}); document.body.appendChild(box);} const p=document.createElement('div'); p.textContent=msg; box.appendChild(p);} 
const imgMap = await loadImage('./map_1.png',{fallbackSize:[2048,2048],label:'map'});
const imgMask= await loadImage('./atarihantei.png',{fallbackSize:[2048,2048],label:'mask'}); // Ëµ§„ÅåÂΩì„Åü„ÇäÂà§ÂÆö
const imgFront=await loadImage('./nikorihito_dot_front.png'); const imgBack=await loadImage('./nikorihito_dot_behind.png'); const imgLeft=await loadImage('./nikorihito_dot_left.png'); const imgRight=await loadImage('./nikorihito_dot_right.png');

/* ===== Canvas & world ===== */
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d'); ctx.imageSmoothingEnabled=false; function resize(){canvas.width=innerWidth; canvas.height=innerHeight;} addEventListener('resize',resize); resize();
const world={w:imgMap.width,h:imgMap.height};

/* ===== Collision (Ëµ§=„Éñ„É≠„ÉÉ„ÇØ) ===== */
const maskCanvas=(typeof OffscreenCanvas!=='undefined')?new OffscreenCanvas(imgMask.width,imgMask.height):Object.assign(document.createElement('canvas'),{width:imgMask.width,height:imgMask.height});
const mctx=maskCanvas.getContext('2d'); mctx.drawImage(imgMask,0,0); const mdata=mctx.getImageData(0,0,imgMask.width,imgMask.height); const mpix=mdata.data; const MW=imgMask.width;
function isBlocked(x,y){x=x|0; y=y|0; if(x<0||y<0||x>=world.w||y>=world.h) return true; const i=(y*MW+x)*4; const r=mpix[i], g=mpix[i+1], b=mpix[i+2], a=mpix[i+3]; if(a<10) return false; return (r>=180 && g<=80 && b<=80);} // Ëµ§„Å£„ÅΩ„ÅÑ
function hits(x,y){const foot=y+(RADIUS*0.6); return isBlocked(x,foot)||isBlocked(x-RADIUS*0.7,foot)||isBlocked(x+RADIUS*0.7,foot);} 
function safeSpawn(maxTry=400){for(let i=0;i<maxTry;i++){const x=Math.random()*(world.w-64)+32, y=Math.random()*(world.h-64)+32; if(!hits(x,y)) return {x,y};} const cx=world.w/2, cy=world.h/2; return {x:cx,y:cy};}

/* ===== Players ===== */
const playersRef=ref(db,`rooms/${ROOM}/players`); const meId=(crypto.randomUUID?crypto.randomUUID():(`m${Math.random().toString(36).slice(2)}`)); const meRef=ref(db,`rooms/${ROOM}/players/${meId}`);
let my=Object.assign({name:NAME,dir:'front',ts:Date.now()}, safeSpawn());
signInAnonymously(auth).catch(()=>{}); try{ await set(meRef,my); }catch(e){ warn('DBÊõ∏„ÅçËæº„ÅøÂ§±Êïó: '+((e&&e.code)||'')+' '+((e&&e.message)||e)); } onDisconnect(meRef).remove();
let players={}; const ghosts={};
onValue(playersRef,snap=>{players=snap.val()||{}; count.textContent=Object.keys(players).length; for(const [id,p] of Object.entries(players)){ if(!ghosts[id]&&p) ghosts[id]={x:p.x,y:p.y,dir:p.dir,name:p.name}; }});

/* ===== Chat ===== */
const chatRef=ref(db,`rooms/${ROOM}/chat`);
const chatView=document.getElementById('chatView'); const textEl=document.getElementById('text'); const sendBtn=document.getElementById('send');
const ctxMenu=document.getElementById('ctxMenu'); let ctxTargetId=null; let replyToMsgId=null; const items=new Map(); const msgIndex=new Map();

function openCtx(x,y){ctxMenu.style.display='block'; ctxMenu.style.left=x+'px'; ctxMenu.style.top=y+'px';}
function closeCtx(){ctxMenu.style.display='none'; ctxTargetId=null;}
addEventListener('click',()=>closeCtx());

function highlightMentions(container, text){
  const meTag='@'+NAME; const parts = text.split(/(@[^\s]+)/g);
  for(const part of parts){
    if(part===meTag){ const span=document.createElement('span'); span.className='mentionSelf'; span.textContent=part; container.appendChild(span); }
    else { container.appendChild(document.createTextNode(part)); }
  }
}

function messageEl(id,m){
  const el=document.createElement('div'); el.className='item'+(m.uid===meId?' me':''); el.dataset.id=id; el.dataset.uid=m.uid||'';
  // Ëøî‰ø°
  if(m.replyTo){ const parent=msgIndex.get(m.replyTo); const r=document.createElement('div'); r.className='replyTo'; r.textContent= parent ? `‚Ü™ ${parent.name||'someone'} „Åï„Çì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏` : '‚Ü™ ÔºàÂÖÉ„É°„ÉÉ„Çª„Éº„Ç∏Ôºâ'; r.onclick=()=>{ const tgt=items.get(m.replyTo); if(tgt){ tgt.scrollIntoView({behavior:'smooth',block:'center'}); }}; el.appendChild(r); if(parent && parent.uid===meId) el.classList.add('replyToMe'); }
  // Êú¨Êñá
  const line=document.createElement('div'); highlightMentions(line, m.text||''); el.appendChild(line);
  // Ê∑ª‰ªòÔºàÁîªÂÉè/Èü≥Â£∞/ÂãïÁîª/PDF„Éó„É¨„Éì„É•„ÉºÔºâ
  if(m.file){ const f=document.createElement('div'); f.className='file'; const t=(m.file.type||'').toLowerCase(); if(t.startsWith('image/')){ const im=document.createElement('img'); im.src=m.file.url; im.alt=m.file.name||''; f.appendChild(im);} else if(t.startsWith('audio/')){ const au=document.createElement('audio'); au.controls=true; au.src=m.file.url; f.appendChild(au);} else if(t.startsWith('video/')){ const vi=document.createElement('video'); vi.controls=true; vi.src=m.file.url; vi.style.maxWidth='280px'; f.appendChild(vi);} else if(t==='application/pdf'){ const fr=document.createElement('iframe'); fr.src=m.file.url; fr.loading='lazy'; fr.style.width='280px'; fr.style.height='200px'; f.appendChild(fr);} const name=document.createElement('a'); name.href=m.file.url; name.target='_blank'; name.rel='noopener'; name.textContent=m.file.name||'file'; f.appendChild(name); el.appendChild(f); }
  // ÊôÇÂàª
  const meta=document.createElement('div'); meta.className='meta'; meta.textContent=new Date(m.ts||Date.now()).toLocaleString(); el.appendChild(meta);
  // Âè≥„ÇØ„É™/Èï∑Êäº„Åó
  el.oncontextmenu=(e)=>{ e.preventDefault(); ctxTargetId=id; openCtx(e.clientX,e.clientY); };
  let pressTimer; el.addEventListener('touchstart',e=>{ pressTimer=setTimeout(()=>{ ctxTargetId=id; const t=e.touches[0]; openCtx(t.clientX,t.clientY); },600); }); el.addEventListener('touchend',()=>clearTimeout(pressTimer));
  return el;
}

const chatQ=query(chatRef,limitToLast(MAX_MSG));
onChildAdded(chatQ,s=>{ const id=s.key,m=s.val()||{}; msgIndex.set(id,m); const el=messageEl(id,m); items.set(id,el); chatView.appendChild(el); chatView.scrollTop=chatView.scrollHeight; });
onChildChanged(chatQ,s=>{ const id=s.key,m=s.val()||{}; msgIndex.set(id,m); const old=items.get(id); if(old){ const el=messageEl(id,m); chatView.replaceChild(el,old); items.set(id,el);} });
onChildRemoved(chatQ,s=>{ const id=s.key; const el=items.get(id); if(el){ el.remove(); items.delete(id);} msgIndex.delete(id); });

async function sendMessage(payload){ await push(chatRef, Object.assign({uid:meId,name:NAME,ts:Date.now()}, payload)); }

// Ëøî‰ø°ÔºöÂè≥„ÇØ„É™„ÉÉ„ÇØ„ÅÆ„Åø
ctxReply.onclick=()=>{ if(!ctxTargetId) return; replyToMsgId=ctxTargetId; closeCtx(); textEl.focus(); };
document.getElementById('editMsg').onclick=async()=>{ if(!ctxTargetId) return; const old=items.get(ctxTargetId); const cur=old?.querySelector('div')?.textContent||''; const t=prompt('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁ∑®ÈõÜ',cur); if(t==null) return; await update(ref(db,`rooms/${ROOM}/chat/${ctxTargetId}`), { text:t.slice(0,2000), edited:true, ts:Date.now() }); closeCtx(); };
document.getElementById('delMsg').onclick=async()=>{ if(!ctxTargetId) return; await remove(ref(db,`rooms/${ROOM}/chat/${ctxTargetId}`)); closeCtx(); };

/* ===== Attachments ===== */
const attachBtn=document.getElementById('attachBtn'); const filePick=document.getElementById('filePick'); const attachModal=document.getElementById('attachModal'); const dropEl=document.getElementById('drop'); const pickFromPc=document.getElementById('pickFromPc'); const attachClose=document.getElementById('attachClose');
const fileChip=document.getElementById('fileChip'); const fileNameEl=document.getElementById('fileName'); const fileClear=document.getElementById('fileClear');
let sendPendingFile=null;

function showAttach(){ attachModal.style.display='flex'; }
function hideAttach(){ attachModal.style.display='none'; dropEl?.classList?.remove('drag'); }
attachBtn.onclick=showAttach; attachClose.onclick=hideAttach; pickFromPc.onclick=()=>filePick.click();
filePick.onchange=()=>{ if(filePick.files?.[0]) handleFiles(filePick.files); };
dropEl.addEventListener('dragover',e=>{ e.preventDefault(); dropEl.classList.add('drag'); });
dropEl.addEventListener('dragleave',()=>dropEl.classList.remove('drag'));
dropEl.addEventListener('drop',e=>{ e.preventDefault(); dropEl.classList.remove('drag'); if(e.dataTransfer.files?.length) handleFiles(e.dataTransfer.files); });

function guessType(name, fallback='application/octet-stream'){
  const ext=(name.split('.').pop()||'').toLowerCase();
  const map={png:'image/png',jpg:'image/jpeg',jpeg:'image/jpeg',gif:'image/gif',webp:'image/webp',mp3:'audio/mpeg',wav:'audio/wav',m4a:'audio/mp4',ogg:'audio/ogg',mp4:'video/mp4',webm:'video/webm',mov:'video/quicktime',mpeg:'video/mpeg',pdf:'application/pdf'};
  return map[ext]||fallback;
}

async function handleFiles(fileList){
  const f=fileList[0]; if(!f) return; 
  try{
    await ensureAnonAuth(auth).catch(e=>{ warn('Ë™çË®ºÂ§±Êïó: '+((e&&e.code)||'')+' '+((e&&e.message)||e)); throw e; });
    const contentType = f.type || guessType(f.name);
    const path=`rooms/${ROOM}/uploads/${(crypto.randomUUID?crypto.randomUUID():Date.now())}_${f.name}`;
    const r=sRef(storage,path);
    const task=uploadBytesResumable(r,f,{ contentType, cacheControl:'public,max-age=3600' });

    // progress UI
    fileNameEl.textContent = `„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠: ${f.name} (0%)`;
    fileChip.style.display='inline-flex';

    await new Promise((resolve,reject)=>{
      task.on('state_changed',(snap)=>{
        const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
        fileNameEl.textContent = `„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠: ${f.name} (${pct}%)`;
      }, reject, resolve);
    });

    const url=await getDownloadURL(r);
    let meta={ name:f.name, url, type:contentType };
    if(meta.type.startsWith('image/')){
      try{ const im=new Image(); im.src=url; await im.decode(); meta.width=im.naturalWidth; meta.height=im.naturalHeight; }catch{}
    }

    if(!textEl.value.trim()){
      await sendMessage({ text:'', file:meta });
      fileChip.style.display='none';
    }else{
      sendPendingFile=meta; fileNameEl.textContent=`Ê∑ª‰ªò: ${meta.name}`; // keep for next send
    }
  }catch(e){
    warn(`„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó: ${(e&&e.code)||''} ${(e&&e.message)||e}`);
    fileChip.style.display='none';
  }finally{
    hideAttach();
    if(filePick) filePick.value='';
  }
}
fileClear.onclick=()=>{ sendPendingFile=null; fileChip.style.display='none'; };

let sending=false;
const sendBtn=document.getElementById('send');
sendBtn.onclick=async()=>{ if(sending) return; const text=textEl.value.trim(); const file=sendPendingFile; if(!text && !file) return; sending=true; try{ const msg={ text:text.slice(0,2000) }; if(replyToMsgId){ msg.replyTo=replyToMsgId; replyToMsgId=null; } if(file){ msg.file=file; sendPendingFile=null; fileChip.style.display='none'; } await sendMessage(msg); textEl.value=''; } finally { sending=false; } };
textEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });

/* ===== Reactions (ÂÖ®Âì°„Å´Ë¶ã„Åà„ÇãÊ≥°) ===== */
const bubblesRef=ref(db,`rooms/${ROOM}/bubbles`);
const reactFab=document.getElementById('reactFab'); const reactMenu=document.getElementById('reactMenu');
function openReactMenu(){ reactMenu.innerHTML=''; EMOJIS.forEach(e=>{ const b=document.createElement('button'); b.textContent=e; b.onclick=()=>{ push(bubblesRef,{uid:meId,emoji:e,ts:Date.now()}); reactMenu.style.display='none'; }; reactMenu.appendChild(b); }); reactMenu.style.display='block'; }
reactFab.onclick=()=>{ reactMenu.style.display = (reactMenu.style.display==='block')?'none':'block'; if(reactMenu.style.display==='block') openReactMenu(); };

const bubbles=new Map();
function showBubbleFor(uid,emoji){ let b=bubbles.get(uid); if(!b){ b=document.createElement('div'); b.className='bubble'; document.body.appendChild(b); bubbles.set(uid,b); } b.textContent=emoji; b.style.display='block'; clearTimeout(b._t); b._t=setTimeout(()=>{ b.style.display='none'; },1800); }

onChildAdded(query(bubblesRef,limitToLast(50)), s=>{ const {uid,emoji,ts}=s.val()||{}; if(!uid||!emoji) return; if(Date.now()-ts>5000) return; showBubbleFor(uid,emoji); });

/* ===== Camera & Render ===== */
function spriteByDir(d){return d==='back'?imgBack:d==='left'?imgLeft:d==='right'?imgRight:imgFront;}
let camX=0, camY=0; function camera(dt){const tx=Math.round(my.x-canvas.width/2), ty=Math.round(my.y-canvas.height/2); const k=Math.min(1,dt*CAM_INTERP); camX+=(tx-camX)*k; camY+=(ty-camY)*k; camX=Math.max(0,Math.min(world.w-canvas.width,camX)); camY=Math.max(0,Math.min(world.h-canvas.height,camY)); return {x:camX,y:camY};}

// Áü¢Âç∞„Ç≠„Éº„ÅÆ„Åø
const keys=new Set(); addEventListener('keydown',e=>{ if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault(); keys.add(e.key); }); addEventListener('keyup',e=>keys.delete(e.key));

let lastSync=0, selfLastX=my.x, selfLastY=my.y, selfLastDir=my.dir; let lastT=performance.now();
function step(now){ if(now-lastT<FRAME_MIN){requestAnimationFrame(step); return;} const dt=Math.min(0.05,(now-lastT)/1000); lastT=now;
  // ÂÖ•Âäõ‚ÜíÁßªÂãïÔºàË°ùÁ™ÅÂà§ÂÆö„ÅÇ„ÇäÔºâ
  let vx=0, vy=0; if(keys.has('ArrowUp')) vy-=1; if(keys.has('ArrowDown')) vy+=1; if(keys.has('ArrowLeft')) vx-=1; if(keys.has('ArrowRight')) vx+=1;
  if(vx||vy){ const len=Math.hypot(vx,vy); vx/=len; vy/=len; const s=SPEED_PPS*dt; const nx=my.x+vx*s, ny=my.y+vy*s; if(!hits(nx,my.y)) my.x=nx; if(!hits(my.x,ny)) my.y=ny; my.dir=Math.abs(vx)>Math.abs(vy)?(vx>0?'right':'left'):(vy>0?'front':'back'); }

  const cam=camera(dt); ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(imgMap, cam.x, cam.y, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);

  // ‰ªñ‰∫∫
  const kInterp=Math.min(1,dt*PLAYER_INTERP);
  for(const [id,p] of Object.entries(players)){
    if(!p||id===meId) continue; const g=(ghosts[id]||={x:p.x,y:p.y,dir:p.dir,name:p.name}); g.x+=(p.x-g.x)*kInterp; g.y+=(p.y-g.y)*kInterp; g.dir=p.dir||g.dir; const im=spriteByDir(g.dir||'front'); const sw=im.width*SCALE, sh=im.height*SCALE; ctx.drawImage(im, Math.round(g.x-sw/2-cam.x), Math.round(g.y-sh/2-cam.y), sw, sh); drawName(g.name||'?', g.x-cam.x, (g.y-sh/2)-cam.y-2,false);
  }
  // Ëá™ÂàÜ
  const meIm=spriteByDir(my.dir), mw=meIm.width*SCALE, mh=meIm.height*SCALE; ctx.drawImage(meIm, Math.round(my.x-mw/2-cam.x), Math.round(my.y-mh/2-cam.y), mw, mh); drawName(NAME,my.x-cam.x,(my.y-mh/2)-cam.y-2,true);

  // „Éê„Éñ„É´‰ΩçÁΩÆÊõ¥Êñ∞
  for(const [uid,b] of bubbles){ const p = uid===meId ? my : (players[uid]||ghosts[uid]); if(!p||b.style.display==='none') continue; const x=(p.x||0)-cam.x, y=(p.y||0)-cam.y; b.style.left=x+'px'; b.style.top=(y - (mh/2) - 24)+'px'; }

  if(now-lastSync>SYNC_MS){ const dx=my.x-selfLastX, dy=my.y-selfLastY; const moved=(dx*dx+dy*dy)>1; const dirChanged=my.dir!==selfLastDir; if(moved||dirChanged){ lastSync=now; selfLastX=my.x; selfLastY=my.y; selfLastDir=my.dir; update(meRef,{x:my.x,y:my.y,dir:my.dir,ts:Date.now()}); } }

  requestAnimationFrame(step);
}
requestAnimationFrame(step);

function drawName(name,x,y,me=false){ ctx.font='12px system-ui, sans-serif'; ctx.textAlign='center'; ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(x-32,y-14,64,16); ctx.fillStyle= me? '#22d3ee' : '#e2e8f0'; ctx.fillText(name,x,y-2); }

// === ÈÄÄÂÆ§„Éú„Çø„É≥ ===
const leaveBtn = document.getElementById('leave');
if (leaveBtn) { leaveBtn.onclick = ()=>{ remove(meRef).finally(()=>{ location.href = './'; }); }; }
addEventListener('beforeunload', ()=>{ try{ remove(meRef); }catch{} });
</script>
</body>
</html>
