<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ニコリタウン - ルーム（安全版）</title>

<style>
  /* ===== 省略：あなたの CSS はすべてそのまま ===== */
  /* フロントUI・HUD・チャットUI・AVUIなど、全て元のまま */
</style>
</head>

<body>
  <canvas id="game"></canvas>

  <!-- ===== HUD, Chat, JoyStick, AV Bar etc（全部あなたのまま） ===== -->
  <!-- （省略：元コードそのまま） -->

<script type="module">
/* ============================================================
   Firebase 設定・プレイヤー処理・チャット機能
   （ここはあなたのオリジナルコードそのまま）
============================================================ */

/* ======== 画像ロードを完全安全化した版 ======== */
function loadImage(src) {
  return new Promise((resolve) => {
    const img = new Image();

    img.onload = () => resolve(img);

    img.onerror = () => {
      console.warn('画像ロード失敗:', src);
      // ★ 黒画像を生成せず null を返す！
      resolve(null);
    };

    img.src = src;
  });
}

/* ======== マップ画像の読み込み ======== */
const imgMap  = await loadImage('./map_1.png?v=20250927-2');
const imgMask = await loadImage('./atarihantei.png?v=20250927-2');

const imgFront = await loadImage('./nikorihito_dot_front.png?v=20250927-2');
const imgBack  = await loadImage('./nikorihito_dot_behind.png?v=20250927-2');
const imgLeft  = await loadImage('./nikorihito_dot_left.png?v=20250927-2');
const imgRight = await loadImage('./nikorihito_dot_right.png?v=20250927-2');


/* ============================================================
   Canvas 初期化
============================================================ */
const canvas = document.getElementById("game");
const ctx     = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

function resizeCanvas(){
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);


/* ============================================================
   マップ or キャラ画像が null の場合、安全にスキップ
============================================================ */

function safeDrawImage(img, sx, sy, sw, sh, dx, dy, dw, dh) {
  if (!img) return; // ★ 画像 null → 描画を無視
  ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
}

/* ============================================================
   当たり判定（imgMask が null の場合は常にFalse）
============================================================ */
let mpix = null;
let MW   = 0;

if (imgMask) {
  const maskCanvas = new OffscreenCanvas(imgMask.width, imgMask.height);
  const mctx = maskCanvas.getContext("2d");
  mctx.drawImage(imgMask, 0, 0);
  const mdata = mctx.getImageData(0, 0, imgMask.width, imgMask.height);
  mpix = mdata.data;
  MW   = imgMask.width;
}

function isBlocked(x, y) {
  if (!mpix) return false; // ★ マスクなし → 常に通れる状態

  x = x | 0;
  y = y | 0;

  const i = (y * MW + x) * 4;
  const r = mpix[i], g = mpix[i+1], b = mpix[i+2], a = mpix[i+3];

  if (a < 10) return false;
  return (r >= 180 && g <= 80 && b <= 80);
}


/* ============================================================
   ★ 描画ループ（マップ画像が null のときスキップ追加）
============================================================ */

function render() {
  // ====== 追加：マップ画像が無い場合はゲームループを進めつつ描画しない ======
  if (!imgMap) {
    requestAnimationFrame(render);
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 背景マップ
  ctx.drawImage(
    imgMap,
    camX, camY,
    canvas.width, canvas.height,
    0, 0,
    canvas.width, canvas.height
  );

  // ----- プレイヤー描画 -----
  // safeDrawImage() を使用して null の場合は無視
  safeDrawImage(spriteByDir(my.dir), 0, 0,
    spriteByDir(my.dir)?.width || 0,
    spriteByDir(my.dir)?.height || 0,
    Math.round(my.x - camX - 32),
    Math.round(my.y - camY - 48),
    (spriteByDir(my.dir)?.width || 0) * SCALE,
    (spriteByDir(my.dir)?.height || 0) * SCALE
  );

  requestAnimationFrame(render);
}

requestAnimationFrame(render);


/* ============================================================
   以下、あなたのキャラ移動・チャット・WebRTCなど
   すべて元のコードのまま（省略）
============================================================ */

</script>
</body>
</html>
